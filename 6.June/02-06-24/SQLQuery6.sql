;WITH Application_CTE As ( 	SELECT JI.ApplyID, JI.JP_ID, JI.P_ID, JI.Score, JI.P_Date, JI.Summary_Viewed, JI.ExpectedSalary, JI.EmpResponse, 0 as AssessmentNeeded, JI.Priority,JP.IsVDOResume	, CASE WHEN JP.JobLang = 2 THEN JB.TITLE ELSE JP.JobTitle END AS [Job Title]	, CASE WHEN JP.JobLang = 2 THEN JB.CompanyNameBng ELSE JP.CompanyName END AS Company	, JV.NoOfApply, JI.Serial	, CASE WHEN JV.NoOfApply > 0 THEN CAST(FORMAT(ROUND(CASE WHEN ((CAST(JI.Serial As float)/JV.NoOfApply)*100) > 0 AND ((CAST(JI.Serial As float)/JV.NoOfApply)*100) < 1 THEN 1 ELSE ((CAST(JI.Serial As float)/JV.NoOfApply)*100) END, 0), '###') As int) ELSE JV.NoOfApply END As PositionStatus	FROM DBO_JOB_INBOX JI 		LEFT JOIN dbo_JOBPOSTINGS JP WITH(NOLOCK) ON JI.JP_ID = JP.JP_ID 		LEFT JOIN bdjCorporate..JobLastViewedDate JV WITH(NOLOCK) ON JV.JP_ID = JP.JP_ID  		LEFT JOIN DBO_BNG_JOBPOSTINGS JB WITH(NOLOCK) ON JP.JP_ID = JB.JP_ID 	WHERE JI.P_ID = 1481759   ORDER BY JI.P_DATE DESC OFFSET 0 ROWS FETCH NEXT 20 ROWS ONLY ), VDO_CTE AS ( 	SELECT II.JP_ID, IA.ApplyId, I.P_ID, (CASE WHEN IA.UserActivity = 0 THEN 1 END) As [Vdo Invitation], DATEADD(DAY,1,II.Deadline) AS Deadline 	, ROW_NUMBER()OVER(PARTITION BY II.JP_ID ORDER BY (CASE WHEN IA.UserActivity = 0 THEN 1 END) DESC ) As SL  	FROM vdo.InterviewInfo II  		INNER JOIN vdo.InterviewApplicants IA ON II.intId = IA.intID 		INNER JOIN Application_CTE I ON IA.ApplyId = I.ApplyID 	WHERE I.P_ID = 1481759), Interview_CTE AS ( 	SELECT DISTINCT T.JP_ID 	, CASE WHEN S.InterviewType < 2 THEN 1 ELSE 0 END AS [General Interview], S.ScheduleDate--, R.ReasonId, R.ReplyText  	, CASE WHEN S.InterviewType = 2 THEN 1 ELSE 0 END AS [Live Interview] , CASE WHEN S.InterviewType = 4 THEN 1 ELSE 0 END AS [Online Test]      , ROW_NUMBER()OVER(PARTITION BY T.JP_ID ORDER BY (CASE WHEN S.InterviewType < 2 THEN 1 ELSE 0 END) DESC , S.ScheduleDate DESC) As SL 	FROM Application_CTE I 		INNER JOIN rp.TestSteps T ON I.JP_ID = T.JP_ID 		INNER JOIN rp.Schedule S ON T.stId = S.stId 		INNER JOIN rp.ApplicantProcess A ON S.schId = A.SchId AND  I.ApplyID = A.ApplyId AND A.Notify=1 	WHERE I.P_ID = 1481759 AND S.ScheduleDate > GETDATE()), Interview_L AS ( 	SELECT I.JP_ID,I.ScheduleDate,I.[Live Interview],I.[Online Test] from Interview_CTE I), VdoResume As ( 	SELECT P_ID, AllowToShow FROM bdjResumes.vdo.VideoResumes WHERE TotalAnswered > 0 AND P_ID =  1481759),CHAT As (  	SELECT C.JP_ID,C.cnvId FROM Application_CTE I INNER JOIN bdjCorporate.rp.empConversation C ON I.JP_ID= C.JP_ID WHERE  c.P_ID =  1481759	)	, CHAT_Unread_Message As (  	SELECT distinct C.JP_ID,count(*) over() as unReadMessage FROM   	Application_CTE I   	INNER JOIN bdjCorporate.rp.empConversation C ON I.JP_ID= C.JP_ID  	INNER JOIN  bdjCorporate.rp.empConversationChat cc ON c.cnvId=cc.cnvId and c.P_ID=I.p_id  and cc.cnvcSenderType='R' and (cc.ReadOn is null or cc.ReadOn='')  	WHERE  C.P_ID =  1481759 ) , percentageCTE AS (    SELECT a.JP_ID, COUNT(CASE WHEN i.Score > a.Score THEN i.applyid END) AS C,COUNT(i.applyid) AS a --, COUNT(CASE WHEN a.applyId IS NOT NULL THEN 1 END) AS c_s    FROM Application_CTE a     LEFT JOIN bdjCorporate..DBO_JOB_INBOX i ON a.JP_ID = i.JP_ID	--LEFT JOIN rp.applicantprocess a1 on i.applyid=a1.applyid    GROUP BY a.JP_ID	--ORDER BY a.JP_ID ) , jobprocess as (    select a.JP_ID,count(case when a.applyid is not null then 1 end) c 	 from Application_CTE a 	 INNER JOIN dbo_job_inbox i on a.JP_ID = i.JP_ID 	 INNER JOIN rp.applicantprocess a1 on i.applyid=a1.applyid 	 group by a.JP_ID	 ORDER BY a.JP_ID )SELECT DISTINCT	J.CP_ID,J.JP_ID,T.P_DATE  	, Company = (CASE WHEN (J.JobLang = 1 OR (J.JobLang = 3 And 'EN' = 'EN')) THEN (CASE WHEN (J.CompanyName IS NULL OR J.CompanyName = '') THEN JB.CompanyNameBng ELSE J.CompanyName END) ELSE (CASE WHEN (JB.CompanyNameBng IS NULL OR JB.CompanyNameBng = '') THEN J.CompanyName ELSE JB.CompanyNameBng END) END) 	, CASE WHEN (J.JobLang = 1 OR (J.JobLang = 3 And 'EN' = 'EN')) THEN J.JobTitle ELSE JB.Title END As JobTitle 	, T.ExpectedSalary, j.Deadline, T.Summary_Viewed, J.JobLang 	, 4577  AS TotalJob, T.EmpResponse 	, 0 as NotCotatct  	,  0  as Cotacted 	,  0  as Haired 	, T.AssessmentNeeded 	,(SELECT COUNT(1) FROM rp.ApplicantProcess WHERE ApplyID = T.ApplyID AND Notify=1 ) As Response 	,(SELECT COUNT(1) FROM rp.ApplicantsResponse WHERE ApplyID = T.ApplyID and Activity =0 ) as Uneen 	, J.MinSalary, J.MaxSalary  	, case when IA. deleted=0 and IA.FinalSubmitted=0  then 1 when  (IA. deleted=0 and IA.FinalSubmitted=1) or DATEADD(month, 2, II.deadline)>=CONVERT(date, getdate()) then 2 else 0 end 	, J.IsVDOResume As [Video Resume Required]	, V.[Vdo Invitation] 	, N.[General Interview]	, L.[Live Interview] 	, (CASE WHEN (SELECT P_ID FROM VdoResume) IS NOT NULL THEN 1 ELSE 0 END) As Vdo_Resume, T.Priority, T.ApplyID 	, NoOfPriority = (select count(CASE WHEN (p.PrioritySetDate >= DATEADD(DD, 0 - DATEPART(DW, GETDATE()),GETDATE()) And inb.Priority = 1) THEN 1 ELSE 0 END) from  PriorityLevelApplications P, Application_CTE inb where  inb.ApplyID = P.ApplyID and inb.p_id=T.p_id) 	, p.Jp_Id	, (SELECT COUNT(1) FROM bdjResumes..Log_CancelApplication WHERE JP_ID = T.JP_ID And P_ID = T.P_ID) As IsCancelApply	, T.Score 	, T.PositionStatus --, CASE WHEN R.P_ID IS NOT NULL OR R.P_ID <> '' THEN 1 ELSE 0 END AS PersonalResume  	, CASE WHEN (N.[General Interview] = 1 AND N.ScheduleDate > GETDATE()) THEN 1 		   WHEN (L.[Live Interview] = 1 AND L.ScheduleDate > GETDATE()) THEN 2 		   WHEN (L.[Online Test] = 1 AND L.ScheduleDate > GETDATE()) THEN 3 		   WHEN (V.[Vdo Invitation] = 1 AND V.Deadline > GETDATE()) THEN 4 		ELSE 0 END AS InterviewInvitation	, AR.ReasonId, AR.ReplyText , case when  T.NoOfApply is null or  T.NoOfApply=0 then pl.a else  T.NoOfApply end  NoOfApply	, 0  as Offered, AR.ID AS JobStatusId 	, (CASE WHEN (SELECT AllowToShow FROM VdoResume) > 0 THEN 1 ELSE 0 END) As VdoResumeOpen ,C.cnvId,CUM.unReadMessage	, CASE WHEN CC.P_ID IS NOT NULL OR CC.P_ID <> '' Then 1 ELSE 0 END MessageInitiate 		, case when T.P_ID = pb.P_ID and T.JP_ID = pb.JP_ID then 1 Else 0 END as [is Boosted]		, CASE WHEN T.ApplyID =  A.ApplyId THEN 1 ELSE 0 END AS isNotify		, CASE WHEN J.JP_ID = CA.JP_ID  THEN 1 ELSE 0 END AS Detailed_view, CAST((pl.C * 100.0 / NULLIF(pl.a, 0)) AS DECIMAL(18, 2)) AS TopApplicantMatchingPercentage	,case when jp.c is not null then 1 else 0 end as isProcessed 	FROM dbo_JOBPOSTINGS J 	INNER JOIN Application_CTE T WITH(NOLOCK) ON T.JP_ID=J.JP_ID 	INNER JOIN percentageCTE pl WITH(NOLOCK) on J.JP_ID = pl.JP_ID 	LEFT JOIN jobprocess jp WITH(NOLOCK) on j.JP_ID =jp.JP_ID 	LEFT JOIN CHAT_Unread_Message CUM WITH(NOLOCK) ON T.JP_ID=CUM.JP_ID  	LEFT JOIN DBO_BNG_JOBPOSTINGS JB WITH(NOLOCK) ON j.JP_ID = JB.JP_ID 	LEFT JOIN vdo.InterviewInfo II WITH(NOLOCK) ON T.JP_ID = II.JP_ID And II.Active = 1 	LEFT JOIN vdo.InterviewApplicants IA WITH(NOLOCK) ON T.ApplyId = IA.Applyid  	LEFT JOIN VDO_CTE V WITH(NOLOCK) ON T.JP_ID = V.JP_ID  AND V.SL = 1  	LEFT JOIN Interview_CTE N WITH(NOLOCK) ON T.JP_ID = N.JP_ID AND N.[General Interview] = 1  AND N.SL = 1 	LEFT JOIN Interview_L L WITH(NOLOCK) ON T.JP_ID = L.JP_ID --AND L.[Live Interview] = 1 --AND L.SL = 1 	LEFT JOIN bdjCorporate..PriorityLevelApplications P WITH(NOLOCK) on T.ApplyID = P.ApplyID 	--LEFT JOIN bdjResumeFiles..ResumeFiles R ON T.P_ID = R.P_ID 	LEFT JOIN  AppliedJobStatus AR WITH(NOLOCK) ON T.ApplyID = AR.ApplyId 	LEFT JOIN CHAT C WITH(NOLOCK) ON T.JP_ID=C.JP_ID  	LEFT JOIN bdjCorporate.rp.empConversation CC WITH(NOLOCK) ON T.P_ID = CC.P_ID AND T.JP_ID = CC.JP_ID  	--LEFT JOIN bdjResumes..UserApplyLimit UA on  R.P_ID = UA.P_ID	--LEFT JOIN bdjResumes.mnt.CandidatePackages cp on UA.pkId = cp.cpkId 	LEFT JOIN bdjResumes.[mnt].[ApplicationBoostingDetails] pb WITH(NOLOCK) on T.P_ID = pb.P_ID and T.JP_ID = pb.JP_ID	LEFT JOIN rp.ApplicantProcess A WITH(NOLOCK) ON T.ApplyID = A.ApplyId 	LEFT JOIN bdjCorporate..CompanyViewedCV CA WITH(NOLOCK) ON J.JP_ID = CA.JP_ID and CA.P_ID = 1481759 and J.CP_ID = CA.CP_ID 	WHERE 1 = 1 ORDER BY T.P_DATE DESC