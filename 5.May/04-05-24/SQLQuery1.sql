WITH mainCTE AS (    SELECT         jp.CP_ID,        c.NAME,        MAX(rp.UpdatedOn) AS date,        COUNT(DISTINCT rp.applyid) AS T_shortlist,        SUM(CASE WHEN j.Score <= 50 THEN 1 ELSE 0 END) AS less_50_percent_shortlisted_applicant_count,        SUM(CASE WHEN j.Score BETWEEN 51 AND 60 THEN 1 ELSE 0 END) AS [51_to_60_percent_shortlisted_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 61 AND 70 THEN 1 ELSE 0 END) AS [61_to_70_percent_shortlisted_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 71 AND 80 THEN 1 ELSE 0 END) AS [71_to_80_percent_shortlisted_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 81 AND 90 THEN 1 ELSE 0 END) AS [81_to_90_percent_shortlisted_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 91 AND 100 THEN 1 ELSE 0 END) AS [91_to_100_percent_shortlisted_applicant_count]    FROM         bdjCorporate..DBO_JOBPOSTINGS AS jp        INNER JOIN bdjCorporate..DBO_JOB_INBOX AS j ON j.JP_ID = jp.JP_ID        INNER JOIN bdjCorporate.rp.ApplicantProcess AS rp ON j.ApplyId = rp.ApplyId        INNER JOIN bdjCorporate..DBO_COMPANY_PROFILES AS c ON c.CP_ID = jp.CP_ID    WHERE         rp.UpdatedOn >= '2024-01-01' and rp.UpdatedOn <= GETDATE()        AND jp.CP_ID >= 1234         AND rp.applyid >= 212118561    GROUP BY         jp.CP_ID, c.NAME	--ORDER BY rp.ApplyId),main_cte2 AS (    SELECT         m.date,        m.CP_ID,        m.NAME,        COUNT(DISTINCT jp.JP_ID) AS T_JOB,        COUNT(j.APPLYID) AS T_apply,		COUNT(CASE WHEN j.Summary_Viewed = 1 THEN j.ApplyID END) AS [Summary View],				--AND j.Summary_Viewed IS NOT NULL 		COUNT(CASE WHEN j.Viewed = 1 THEN j.ApplyID END) AS [Detailed View],					--AND j.Viewed IS NOT NULL         m.T_shortlist,        SUM(CASE WHEN j.Score <= 50 THEN 1 ELSE 0 END) AS less_50_percent_total_applicant_count,        SUM(CASE WHEN j.Score BETWEEN 51 AND 60 THEN 1 ELSE 0 END) AS [51_to_60_percent_total_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 61 AND 70 THEN 1 ELSE 0 END) AS [61_to_70_percent_total_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 71 AND 80 THEN 1 ELSE 0 END) AS [71_to_80_percent_total_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 81 AND 90 THEN 1 ELSE 0 END) AS [81_to_90_percent_total_applicant_count],        SUM(CASE WHEN j.Score BETWEEN 91 AND 100 THEN 1 ELSE 0 END) AS [91_to_100_percent_total_applicant_count],        m.less_50_percent_shortlisted_applicant_count,        m.[51_to_60_percent_shortlisted_applicant_count],        m.[61_to_70_percent_shortlisted_applicant_count],        m.[71_to_80_percent_shortlisted_applicant_count],        m.[81_to_90_percent_shortlisted_applicant_count],        m.[91_to_100_percent_shortlisted_applicant_count]    FROM         mainCTE m        INNER JOIN bdjCorporate..DBO_JOBPOSTINGS AS jp ON m.CP_ID = jp.CP_ID        INNER JOIN bdjCorporate..DBO_JOB_INBOX AS j ON jp.JP_ID = j.JP_ID    WHERE         jp.JP_ID >=  412884     --509891        AND j.ApplyID >=  8694811   --27480323   GROUP BY        m.date,        m.CP_ID,        m.NAME,        m.T_shortlist,        m.less_50_percent_shortlisted_applicant_count,        m.[51_to_60_percent_shortlisted_applicant_count],        m.[61_to_70_percent_shortlisted_applicant_count],        m.[71_to_80_percent_shortlisted_applicant_count],        m.[81_to_90_percent_shortlisted_applicant_count],        m.[91_to_100_percent_shortlisted_applicant_count])SELECT     CONVERT(DATE, m1.date, 101) AS [Date],	m1.CP_ID as [CP_ID],    m1.NAME AS [cp_name],    m1.T_JOB AS [total_jobpost],    m1.T_apply AS [total_applicant],	m1.[Summary View],	m1.[Detailed View],    m1.T_shortlist AS [total_shortlisted_applicant],    m1.less_50_percent_total_applicant_count,    m1.[51_to_60_percent_total_applicant_count],    m1.[61_to_70_percent_total_applicant_count],    m1.[71_to_80_percent_total_applicant_count],    m1.[81_to_90_percent_total_applicant_count],    m1.[91_to_100_percent_total_applicant_count],    m1.less_50_percent_shortlisted_applicant_count,    m1.[51_to_60_percent_shortlisted_applicant_count],    m1.[61_to_70_percent_shortlisted_applicant_count],    m1.[71_to_80_percent_shortlisted_applicant_count],    m1.[81_to_90_percent_shortlisted_applicant_count],    m1.[91_to_100_percent_shortlisted_applicant_count]FROM     main_cte2 m1