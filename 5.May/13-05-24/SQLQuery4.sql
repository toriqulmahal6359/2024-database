WITH maincte AS (    SELECT DISTINCT        p.applyid,        j.jp_id,        jp.cp_id,        c.name AS [company name],        CONVERT(date, rp.createdon, 101) AS [creation date],        CASE            WHEN jp.joblang = 2 THEN bj.title            ELSE jp.jobtitle        END AS [job title]     FROM        bdjcorporate..dbo_job_inbox j        INNER JOIN bdjcorporate..dbo_jobpostings AS jp ON jp.jp_id = j.jp_id        LEFT JOIN bdjcorporate..dbo_bng_jobpostings AS bj ON bj.jp_id = jp.jp_id        INNER JOIN bdjcorporate.rp.teststeps rp ON j.jp_id = rp.jp_id AND rp.testtype = 'aiasmnt'        INNER JOIN bdjcorporate.rp.applicantprocess p ON j.applyid = p.applyid AND p.levelstatus = rp.testlevel        INNER JOIN bdjcorporate..dbo_company_profiles AS c ON c.cp_id = jp.cp_id    WHERE        p.updatedon >= '03/10/2024 14:00:00'        AND j.p_id NOT IN (SELECT p_id FROM listofpid)        --AND jp.cp_id NOT IN (SELECT cp_id FROM listofcp_id)        AND jp.cp_id NOT IN (35450, 110412, 38918, 114174))SELECT    c.[company name],    c.cp_id,    COUNT(DISTINCT c.jp_id) AS 'no. of jobs ai assessment created',    [job title],    c.[creation date],    COUNT(DISTINCT c.applyid) AS [no. of applicants moved for ai assessment step],    COUNT(DISTINCT ai.applyid) AS [number of applicants invited],    COUNT(DISTINCT CASE WHEN ai.answeredon IS NOT NULL AND ai.finalsubmitted = 1 THEN ai.applyid END) AS [no. of applicants submitted ai assessment],    COUNT(DISTINCT CASE WHEN ai.answeredon IS NOT NULL AND ai.finalsubmitted = 1 AND ai.devicetype = 'web' THEN ai.applyid END) AS 'no. of applicants submitted ai assessment (web) upload',    COUNT(DISTINCT CASE WHEN ai.answeredon IS NOT NULL AND ai.finalsubmitted = 1 AND ai.devicetype = 'app' THEN ai.applyid END) AS 'no. of applicants submitted ai assessment (app) upload'FROM    maincte AS c    LEFT JOIN bdjcorporate.[aiass].[aiassessmentapplicants] AS ai ON ai.applyid = c.applyidGROUP BY    c.jp_id,    c.cp_id,    c.[company name],    [job title],    c.[creation date]HAVING    COUNT(DISTINCT ai.applyid) >= 3ORDER BY    c.cp_id;