; WITH tmpPersonalK1 AS ( SELECT distinct P.P_ID, P.smTExp, P.smRankpoint--, ROW_NUMBER()OVER(PARTITION BY P.P_ID ORDER BY  P.smTExp DESC) As OrderKey--, COUNT(1) OVER() AS TotalCVFROM bdjActiveResumeData.src.ResumeDataSummary PWHERE 1 = 1		And (P.smLastUpdated >= '2023/05/15') AND (CONTAINS(P.smPresentLoc,'"1645"') OR CONTAINS(P.smPresentLoc,'"1644"') OR CONTAINS(P.smPresentLoc,'"1377"') OR CONTAINS(P.smPresentLoc,'"4252"') OR CONTAINS(P.smPresentLoc,'"4278"')) And P.smGender IN ('F')		And P.smTExp <= 24 And NOT EXISTS (SELECT * FROM bdjResumes..Block_EMP WHERE P_ID =  P.P_ID And BLOCKED_CP_ID like '%,35450,%')), tmpPersonalK AS (  		SELECT *, 1 AS T--, COUNT(DISTINCT CASE WHEN smRankpoint >= 40 THEN P_ID END) As TotalStar, COUNT(1) OVER() AS TotalCV	FROM tmpPersonalK1  	GROUP BY P_ID, smTExp, smRankpoint--, OrderKey ), tmpPersonalK2 AS (  		SELECT 1 AS T, COUNT(DISTINCT CASE WHEN smRankpoint >= 40 THEN P_ID END) AS TotalStar , COUNT(1) AS TotalCV	FROM tmpPersonalK1  ) SELECT K.P_ID,K.smName,K.smEmail,K.smMobile,K.smPhone, NULL AS PRESENT_ADD, K.smTopEducation AS TopEducation,K.smTopInstitute,smBirth,NULL AS UPDATED, K.smTExp  , K.smPhotoName AS PhotoName,smCurSal,smExpSal, 0 AS TWatchlisted, 0 AS Certification,SK.rdSkills AS Skill, SK.rdEXP AS AREA_OF_EXP, PW.CandidateListID, PW.PurchaseListName  , PW.TiLLDate,PW.WishToPurchase,PW.AlreadyPurchase, 0 AS	Certified ,vdoCVExist, CASE WHEN smCVFileType IS NOT NULL OR smCVFileType <> '' THEN 1 ELSE 0 END AttachCV  , smCVFileType ,K.smRankPoint, 1 AS OrderKey, K.smExpPosition, K.smExpCompany ,  C.TotalCV,  C.TotalStar   , smPresentAddress AS UserLocation, smCatId,(SELECT TOP 1 ServiceId FROM bdjCorporate..CompanyViewedCV WHERE CP_ID = 35450 AND P_ID = P.P_ID ORDER BY ViewId DESC) As ServiceId,	0 AS AccCreatedBy, K.smGender   FROM tmpPersonalK P INNER JOIN tmpPersonalK2 C ON P.T = C.T  --INNER JOIN bdjActiveResumeData.src.ResumeDataSummary K ON P.P_ID = K.P_ID  LEFT JOIN  bdjResumes.[fts].[ResumeData] SK ON P.P_ID = SK.P_ID	 LEFT JOIN bdjResumes..vPurchaseWishList PW ON P.P_ID = PW.P_ID And PW.CP_ID = 35450	ORDER BY smTExp desc , P.P_ID  offset 0 rows fetch next 25 rows only--ai query slow cv bank a