;WITH Job_CTE As (	SELECT J.JP_ID	FROM arcCorporate..DBO_JOBPOSTINGS_arc J 	WHERE J.CP_ID = 18954 And J.Drafted = 0  And J.Deleted=0 And (J.RegionalJob <> 4 OR J.RegionalJob IS NULL)	UNION	SELECT J.JP_ID	FROM arcCorporate..DBO_JOBPOSTINGS_arc J 		LEFT JOIN UserJobAccess UA ON J.JP_ID = UA.JP_ID	WHERE J.CP_ID = 18954 And J.Drafted = 0  And J.Deleted=0 And (J.RegionalJob <> 4 OR J.RegionalJob IS NULL) And UA.JP_ID IS NULL		And CAST('' As smalldatetime) < CAST(GETDATE() AS smalldatetime)), New_CTE1 As ( SELECT J.JP_ID, CASE WHEN J.JobLang = 2 THEN BJ.Title ELSE J.JobTitle END As JobTitle, J.Verified, J.Deadline, J.AdType, B.JType, J.Closed	, COUNT(I.ApplyID) ApplicantNo, COUNT(1) OVER() As TotalJob, J.ProceedToPublishDate, 0 As NEW	, (SELECT NewDesign FROM DBO_COMPANY_PROFILES WHERE CP_ID = J.CP_ID) As NewDesign	, (SELECT COUNT(1) FROM rp.TestSteps WHERE JP_ID = J.JP_ID) As TotalStep	, C.ApropriateCandidate, C.Rank, 0 AS InProgress, J.PublishDate,CASE WHEN  (select COUNT(distinct StepNo) from JobStepsLog WHERE JP_ID = j.jp_id And StepNo IN (1,2,4) And IsBangla = CASE WHEN J.JobLang in (2,3) then 1 else 0 end  )  = 3 then 1 else 0 end As StepLog 	, COUNT(CASE WHEN I.Hired = 1 THEN I.ApplyID END) TotalHired FROM Job_CTE JC INNER JOIN arcCorporate..DBO_JOBPOSTINGS_arc J ON JC.JP_ID = J.JP_ID	LEFT JOIN arcCorporate..DBO_BNG_JOBPOSTINGS_arc BJ ON J.JP_ID = BJ.JP_ID	LEFT JOIN arcCorporate..dbo_job_inbox_arc i ON J.JP_ID = I.JP_ID	LEFT JOIN arcCorporate..JobBillInfo_arc B ON J.JP_ID = B.JP_ID	LEFT JOIN arcCorporate.rp.jobCloser_arc C ON J.JP_ID = C.JP_IDWHERE J.CP_ID = 18954 And J.Drafted = 0 And J.Deleted = 0GROUP BY J.CP_ID, J.JP_ID, CASE WHEN J.JobLang = 2 THEN BJ.Title ELSE J.JobTitle END, J.Verified,J.PublishDate, j.Deadline, j.AdType, B.JType, j.Closed, J.ProceedToPublishDate,C.ApropriateCandidate, C.Rank,J.JobLang ),  New_CTE2 As ( SELECT J.JP_ID, COUNT(A.ApplyID) AS Total, A.LevelStatus, ROW_NUMBER() OVER(PARTITION BY J.JP_ID ORDER BY A.LevelStatus)r								FROM Job_CTE jc inner join dbo_job_inbox J ON jc.jp_id=j.jp_id								INNER JOIN rp.ApplicantProcess A ON J.ApplyID = A.ApplyID								WHERE A.LevelStatus <=6								GROUP BY J.JP_ID,A.LevelStatus), New_CTE3 As ( SELECT JP_ID, Total, LevelStatus FROM New_CTE2 where r = 1)  SELECT C1.JP_ID, C1.JobTitle, C1.Verified, C1.Deadline, C1.AdType, C1.JType, C1.Closed, c1.ApplicantNo, c1.TotalJob, c1.ProceedToPublishDate, c1.NEW, c1.NewDesign, c1.TotalStep,						c2.Total, c2.LevelStatus,C1.ApropriateCandidate, C1.Rank, C1.InProgress, C1.StepLog, C1.PublishDate, C1.TotalHired						FROM New_CTE1 C1 						LEFT JOIN New_CTE3 C2 ON C1.JP_ID = C2.JP_ID						ORDER BY c1.ProceedToPublishDate desc, c1.jP_ID desc OFFSET 0  ROWS FETCH  NEXT 20 ROWS ONLY