DECLARE 	@pageNumber INT = 3,	@pageRows INT = 20,	@cp_Id INT = 18954;;WITH Job_CTE As (	SELECT J.JP_ID	FROM arcCorporate..DBO_JOBPOSTINGS_arc J 	WHERE J.CP_ID = @cp_Id And J.Drafted = 0  And J.Deleted=0 And (J.RegionalJob <> 4 OR J.RegionalJob IS NULL)	UNION	SELECT J.JP_ID	FROM arcCorporate..DBO_JOBPOSTINGS_arc J 		LEFT JOIN UserJobAccess UA ON J.JP_ID = UA.JP_ID	WHERE J.CP_ID = @cp_Id And J.Drafted = 0  And J.Deleted=0 And (J.RegionalJob <> 4 OR J.RegionalJob IS NULL) And UA.JP_ID IS NULL		And CAST('' As smalldatetime) < CAST(GETDATE() AS smalldatetime))--SELECT * FROM Job_CTE AS j, cte1 AS (	SELECT J.*	,COUNT(CASE WHEN I.Hired = 1 THEN I.ApplyID END) AS TotalHired	,COUNT(i.ApplyId) AS ApplicantNo	FROM Job_CTE AS J 	LEFT JOIN arcCorporate..dbo_job_inbox_arc AS i ON i.JP_ID = j.JP_ID	GROUP BY j.JP_ID), cte2 AS (	SELECT jc.*	, CASE WHEN J.JobLang = 2 THEN BJ.Title ELSE J.JobTitle END As JobTitle 	, J.Verified, J.Deadline, J.AdType, J.Closed	, J.ProceedToPublishDate	, J.PublishDate	, (SELECT NewDesign FROM DBO_COMPANY_PROFILES WHERE CP_ID = J.CP_ID) As NewDesign	, (SELECT COUNT(1) FROM rp.TestSteps WHERE JP_ID = J.JP_ID) As TotalStep	, CASE WHEN (select COUNT(distinct StepNo) from JobStepsLog WHERE JP_ID = j.jp_id And StepNo IN (1,2,4) And IsBangla = CASE WHEN J.JobLang in (2,3) then 1 else 0 end  )  = 3 then 1 else 0 end As StepLog 	, 0 AS New	FROM Job_CTE AS jc	INNER JOIN arcCorporate..DBO_JOBPOSTINGS_arc J ON JC.JP_ID = J.JP_ID	LEFT JOIN arcCorporate..DBO_BNG_JOBPOSTINGS_arc BJ ON J.JP_ID = BJ.JP_ID	WHERE J.CP_ID = @cp_Id AND j.Drafted = 0 AND j.Deleted = 0), cte3 AS (	SELECT j.*, C.ApropriateCandidate, C.Rank, 0 AS InProgress, B.JType	, COUNT(1) OVER() As TotalJob	FROM cte2 AS j	LEFT JOIN arcCorporate.rp.jobCloser_arc C ON J.JP_ID = C.JP_ID	LEFT JOIN arcCorporate..JobBillInfo_arc B ON J.JP_ID = B.JP_ID), cte4 AS (	SELECT i.ApplicantNo, i.TotalHired, j.* FROM cte1 AS i	LEFT JOIN cte3 AS j ON i.JP_ID = j.JP_ID), New_CTE2 As ( SELECT J.JP_ID, COUNT(A.ApplyID) AS Total, A.LevelStatus, ROW_NUMBER() OVER(PARTITION BY J.JP_ID ORDER BY A.LevelStatus)r								FROM Job_CTE jc inner join dbo_job_inbox J ON jc.jp_id=j.jp_id								INNER JOIN rp.ApplicantProcess A ON J.ApplyID = A.ApplyID								WHERE A.LevelStatus <= 6								GROUP BY J.JP_ID,A.LevelStatus), New_CTE3 As (SELECT JP_ID, Total, LevelStatus FROM New_CTE2 where r = 1) SELECT C4.JP_ID, C4.JobTitle, C4.Verified, C4.Deadline, C4.AdType, C4.JType, C4.Closed, c4.ApplicantNo , c4.TotalJob, c4.ProceedToPublishDate, c4.NEW, c4.NewDesign, c4.TotalStep,C2.Total, C2.LevelStatus, C4.ApropriateCandidate, C4.Rank, C4.InProgress, C4.StepLog, C4.PublishDate, C4.TotalHired						FROM cte4 C4 						LEFT JOIN New_CTE3 C2 ON C4.JP_ID = C2.JP_ID						ORDER BY c4.ProceedToPublishDate desc, C4.jP_ID desc OFFSET (@pageNumber - 1) * @pageRows ROWS FETCH NEXT @pageRows ROWS ONLY