WITH packageCTE AS (	SELECT DISTINCT o.P_ID, c.cpkStartDate, DATEADD(MONTH, c.cpkDuration, c.cpkStartDate) AS EndDate	FROM bdjResumes..OnlinePaymentInfoJS AS o 	INNER JOIN bdjResumes.mnt.CandidatePackages AS c ON c.P_ID = o.P_ID AND o.SysId = c.cpkId	WHERE o.ServiceID IN (87, 88, 89) AND o.TransStatus = 'S'	AND c.IsActive = 1 ), proCTE AS (	SELECT DISTINCT p.P_ID, p.cpkStartDate, p.EndDate 	FROM packageCTE AS p	WHERE p.cpkStartDate <='03/31/2024' and CONVERT(DATE, p.EndDate, 101) >= '03/01/2024' --AND CONVERT(DATE, p.EndDate, 101) <= '03/31/2024'), finalCTE AS (	SELECT DISTINCT j.JP_ID,	ApplyId,	p.P_ID	, j.P_DATE	, j.Score	FROM procte AS p	INNER JOIN bdjCorporate..DBO_JOB_INBOX AS j ON j.P_ID = p.P_ID	where P_DATE >= '03/01/2024' and P_DATE < '04/01/2024' and P_DATE >=p.cpkStartDate AND j.P_DATE <= p.EndDate)SELECT DISTINCT f.P_DATE, f.P_ID, f.JP_ID, f.Score [Matching(%)],CASE WHEN r.ApplyId IS NOT NULL THEN 'Y' ELSE 'N' END AS [Shortlisted (Y/N)],CASE WHEN b.P_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS [Boosted (Y/N)],CASE WHEN m.P_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS [Messaging (Y/N)],CASE WHEN c.P_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS [CV Viewed (Y/N)]FROM finalCTE AS fLEFT JOIN bdjCorporate.rp.ApplicantProcess AS r ON  f.ApplyId = r.ApplyId LEFT JOIN bdjResumes.mnt.ApplicationBoostingDetails AS b oN f.JP_ID = b.JP_ID AND f.P_ID =  b.P_IDLEFT JOIN bdjCorporate..CompanyViewedCV AS c ON f.P_ID = c.P_ID AND f.JP_ID = c.JP_ID LEFT JOIN bdjCorporate.rp.empConversation AS m ON f.P_ID =  m.P_ID AND m.JP_ID = f.JP_IDORDER BY f.P_DATE