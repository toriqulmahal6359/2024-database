;WITH packageCTE AS (	SELECT DISTINCT o.P_ID,o.ServiceID, 	c.cpkStartDate AS [Start Date], DATEADD(MONTH, cpkDuration, cpkStartDate) AS EndDate 	FROM bdjResumes..OnlinePaymentInfoJS AS o	INNER JOIN mnt.CandidatePackages AS c ON c.P_ID = o.P_ID AND o.SysID = c.cpkId	WHERE o.ServiceId IN (87, 88, 89) AND o.TransStatus = 'S'),final as(SELECT p.P_ID, case when j.P_DATE >= p.[Start Date] AND j.P_DATE <= p.EndDate then J.ApplyID end as Applyid, j.P_DATE,jo.CP_IDFROM bdjCorporate..[DBO_JOB_INBOX] AS jINNER JOIN  packageCTE AS p ON p.P_ID = j.P_ID inner join bdjCorporate..DBO_JOBPOSTINGS jo on j.JP_ID=Jo.JP_ID),finalpart as(select  distinct f.P_ID,f.Applyid,CONVERT(Date, p.UpdatedOn, 101) AS [Date],f.CP_IDfrom final finner join bdjCorporate.rp.ApplicantProcess p on f.applyid = p.applyidwhere f.Applyid is not null),maincte as(select f.[Date],count(distinct f.applyid) as P_Apply,count(distinct f.CP_ID) as P_unique_companyfrom finalpart fgroup by f.[Date]--order by f.[Date]),maincte1 as(select CONVERT(Date, p.UpdatedOn, 101) AS [Date],count(distinct p.applyid) as totalApply,count(distinct Jo.CP_ID) as totalcompanyfrom  bdjCorporate..DBO_JOBPOSTINGS jo INNER JOIN bdjCorporate..DBO_JOB_INBOX j on jo.JP_ID=J.JP_ID inner join bdjCorporate.rp.ApplicantProcess p  on j.applyid =p.applyidwhere p.updatedon >='2023-11-30'GROUP BY CONVERT(Date, p.UpdatedOn, 101) )select m1.Date,m.P_Apply,m.P_unique_company,m1.totalApply,m1.totalcompanyfrom maincte m left join maincte1 m1 on m.Date = m1.Dateorder by m1.Date