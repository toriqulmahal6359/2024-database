SELECT TOP 100 * FROM rp.ApplicantProcess ORDER BY UpdatedOn DESC WHERE UserId = 6056723

;WITH Application_CTE As ( 	SELECT DISTINCT JI.ApplyID, JI.JP_ID, JI.P_ID, JI.Score, JI.P_Date, JI.Summary_Viewed, JI.ExpectedSalary, JI.EmpResponse, 0 as AssessmentNeeded, JI.Priority,JP.IsVDOResume	, CASE WHEN JP.JobLang = 2 THEN JB.TITLE ELSE JP.JobTitle END AS [Job Title]	, CASE WHEN JP.JobLang = 2 THEN JB.CompanyNameBng ELSE JP.CompanyName END AS Company	, JV.NoOfApply, JI.Serial	, CASE WHEN JV.NoOfApply > 0 THEN CAST(FORMAT(ROUND(CASE WHEN ((CAST(JI.Serial As float)/JV.NoOfApply)*100) > 0 AND ((CAST(JI.Serial As float)/JV.NoOfApply)*100) < 1 THEN 1 ELSE ((CAST(JI.Serial As float)/JV.NoOfApply)*100) END, 0), '###') As int) ELSE JV.NoOfApply END As PositionStatus	, CASE WHEN A.ApplyId IS NOT NULL THEN 1 ELSE 0 END [Status]	FROM DBO_JOB_INBOX JI 		LEFT JOIN rp.ApplicantProcess A ON JI.ApplyID = A.ApplyId		LEFT JOIN dbo_JOBPOSTINGS JP ON JI.JP_ID = JP.JP_ID 		LEFT JOIN bdjCorporate..JobLastViewedDate JV ON JV.JP_ID = JP.JP_ID  		LEFT JOIN DBO_BNG_JOBPOSTINGS JB ON JP.JP_ID = JB.JP_ID 	WHERE JI.P_ID = 6056723   ORDER BY  JI.P_DATE DESC OFFSET 0 ROWS FETCH NEXT 200 ROWS ONLY ), VDO_CTE AS ( 	SELECT II.JP_ID, IA.ApplyId, I.P_ID, (CASE WHEN IA.UserActivity = 0 THEN 1 END) As [Vdo Invitation], DATEADD(DAY,1,II.Deadline) AS Deadline 	, ROW_NUMBER()OVER(PARTITION BY II.JP_ID ORDER BY (CASE WHEN IA.UserActivity = 0 THEN 1 END) DESC ) As SL  	FROM vdo.InterviewInfo II  		INNER JOIN vdo.InterviewApplicants IA ON II.intId = IA.intID 		INNER JOIN Application_CTE I ON IA.ApplyId = I.ApplyID 	WHERE I.P_ID = 6056723  --63321   --6056723  --131805), Interview_CTE AS ( 	SELECT DISTINCT T.JP_ID 	, CASE WHEN S.InterviewType < 2 THEN 1 ELSE 0 END AS [General Interview], S.ScheduleDate--, R.ReasonId, R.ReplyText  	, CASE WHEN S.InterviewType = 2 THEN 1 ELSE 0 END AS [Live Interview] , CASE WHEN S.InterviewType = 4 THEN 1 ELSE 0 END AS [Online Test]	, CASE WHEN A.ApplyId IS NOT NULL THEN 1 ELSE 0 END AS [NOTIFY_Status]     , ROW_NUMBER()OVER(PARTITION BY T.JP_ID ORDER BY (CASE WHEN S.InterviewType < 2 THEN 1 ELSE 0 END) DESC , S.ScheduleDate DESC) As SL 	FROM Application_CTE I 		INNER JOIN rp.TestSteps T ON I.JP_ID = T.JP_ID 		INNER JOIN rp.Schedule S ON T.stId = S.stId 		INNER JOIN rp.ApplicantProcess A ON S.schId = A.SchId AND  I.ApplyID = A.ApplyId AND A.Notify=1 	WHERE I.P_ID = 6056723 AND S.ScheduleDate > GETDATE()), Interview_L AS ( 	SELECT I.JP_ID,I.ScheduleDate,I.[Live Interview],I.[Online Test] from Interview_CTE I), VdoResume As ( 	SELECT P_ID, AllowToShow FROM bdjResumes.vdo.VideoResumes WHERE TotalAnswered > 0 AND P_ID =  6056723),CHAT As (  	SELECT C.JP_ID,C.cnvId FROM Application_CTE I INNER JOIN bdjCorporate.rp.empConversation C ON I.JP_ID= C.JP_ID WHERE  c.P_ID =  6056723	), CHAT_Unread_Message As (  	SELECT distinct C.JP_ID,count(*) over() as unReadMessage FROM   	Application_CTE I   	INNER JOIN bdjCorporate.rp.empConversation C ON I.JP_ID= C.JP_ID  	INNER JOIN  bdjCorporate.rp.empConversationChat cc ON c.cnvId=cc.cnvId and c.P_ID=I.p_id  and cc.cnvcSenderType='R' and (cc.ReadOn is null or cc.ReadOn='')  	WHERE  C.P_ID = 6056723)SELECT DISTINCT J.CP_ID,J.JP_ID,T.P_DATE  	, Company = (CASE WHEN (J.JobLang = 1 OR (J.JobLang = 3 And 'EN' = 'EN')) THEN (CASE WHEN (J.CompanyName IS NULL OR J.CompanyName = '') THEN JB.CompanyNameBng ELSE J.CompanyName END) ELSE (CASE WHEN (JB.CompanyNameBng IS NULL OR JB.CompanyNameBng = '') THEN J.CompanyName ELSE JB.CompanyNameBng END) END) 	, CASE WHEN (J.JobLang = 1 OR (J.JobLang = 3 And 'EN' = 'EN')) THEN J.JobTitle ELSE JB.Title END As JobTitle 	, T.ExpectedSalary, j.Deadline, T.Summary_Viewed, J.JobLang 	, 70  AS TotalJob, T.EmpResponse 	, 11 as NotCotatct  	,  0  as Cotacted 	,  0  as Haired 	, T.AssessmentNeeded, (SELECT COUNT(1) FROM rp.ApplicantProcess WHERE ApplyID = T.ApplyID AND Notify=1 ) As Response, (SELECT COUNT(1) FROM rp.ApplicantsResponse WHERE ApplyID = T.ApplyID and Activity =0 ) as Uneen 	, J.MinSalary, J.MaxSalary  	, case when IA. deleted=0 and IA.FinalSubmitted=0  then 1 when  (IA. deleted=0 and IA.FinalSubmitted=1) or DATEADD(month, 2, II.deadline)>=CONVERT(date, getdate()) then 2 else 0 end 	, J.IsVDOResume As [Video Resume Required], V.[Vdo Invitation] , N.[General Interview], L.[Live Interview] 	, (CASE WHEN (SELECT P_ID FROM VdoResume) IS NOT NULL THEN 1 ELSE 0 END) As Vdo_Resume, T.Priority, T.ApplyID 	, NoOfPriority = (select count(CASE WHEN (p.PrioritySetDate >= DATEADD(DD, 0 - DATEPART(DW, GETDATE()),GETDATE()) And inb.Priority = 1) THEN 1 ELSE 0 END) from  PriorityLevelApplications P, Application_CTE inb where  inb.ApplyID = P.ApplyID and inb.p_id=T.p_id) 	, p.Jp_Id, (SELECT COUNT(1) FROM bdjResumes..Log_CancelApplication WHERE JP_ID = T.JP_ID And P_ID = T.P_ID) As IsCancelApply, T.Score  	 , CASE WHEN (N.[General Interview] = 1 AND N.ScheduleDate > GETDATE()) THEN 1 WHEN (L.[Live Interview] = 1 AND L.ScheduleDate > GETDATE()) THEN 2 WHEN (L.[Online Test] = 1 AND L.ScheduleDate > GETDATE()) THEN 3 WHEN (V.[Vdo Invitation] = 1 AND V.Deadline > GETDATE()) THEN 4 ELSE 0 END AS InterviewInvitation	, AR.ReasonId, AR.ReplyText , T.NoOfApply	, 0  as Offered, AR.ID AS JobStatusId 	, (CASE WHEN (SELECT AllowToShow FROM VdoResume) > 0 THEN 1 ELSE 0 END) As VdoResumeOpen ,C.cnvId,CUM.unReadMessage	, CASE WHEN CC.P_ID IS NOT NULL OR CC.P_ID <> '' Then 1 ELSE 0 END MessageInitiate	, T.Status	FROM dbo_JOBPOSTINGS J 	INNER JOIN Application_CTE T ON T.JP_ID=J.JP_ID 	LEFT JOIN CHAT_Unread_Message CUM ON T.JP_ID=CUM.JP_ID  	LEFT JOIN DBO_BNG_JOBPOSTINGS JB ON j.JP_ID = JB.JP_ID 	LEFT JOIN vdo.InterviewInfo II ON T.JP_ID = II.JP_ID And II.Active = 1 	LEFT JOIN vdo.InterviewApplicants IA ON T.ApplyId = IA.Applyid  	LEFT JOIN VDO_CTE V ON T.JP_ID = V.JP_ID  AND V.SL = 1  	LEFT JOIN Interview_CTE N ON T.JP_ID = N.JP_ID AND N.[General Interview] = 1  AND N.SL = 1 	LEFT JOIN Interview_L L ON T.JP_ID = L.JP_ID --AND L.[Live Interview] = 1 AND L.SL = 1 	LEFT JOIN bdjCorporate..PriorityLevelApplications P on T.ApplyID = P.ApplyID 	LEFT JOIN  AppliedJobStatus AR ON T.ApplyID = AR.ApplyId 	LEFT JOIN CHAT C ON T.JP_ID=C.JP_ID  	LEFT JOIN bdjCorporate.rp.empConversation CC ON T.P_ID = CC.P_ID AND T.JP_ID = CC.JP_ID  	WHERE 1 = 1 ORDER BY T.P_DATE DESC WITH Application_CTE As ( 	SELECT DISTINCT JI.ApplyID, JI.JP_ID, JI.P_ID, JI.Score, JI.P_Date, JI.Summary_Viewed, JI.ExpectedSalary, JI.EmpResponse, 0 as AssessmentNeeded, JI.Priority,JP.IsVDOResume	, CASE WHEN JP.JobLang = 2 THEN JB.TITLE ELSE JP.JobTitle END AS [Job Title]	, CASE WHEN JP.JobLang = 2 THEN JB.CompanyNameBng ELSE JP.CompanyName END AS Company	, JV.NoOfApply, JI.Serial	, CASE WHEN JV.NoOfApply > 0 THEN CAST(FORMAT(ROUND(CASE WHEN ((CAST(JI.Serial As float)/JV.NoOfApply)*100) > 0 AND ((CAST(JI.Serial As float)/JV.NoOfApply)*100) < 1 THEN 1 ELSE ((CAST(JI.Serial As float)/JV.NoOfApply)*100) END, 0), '###') As int) ELSE JV.NoOfApply END As PositionStatus	FROM DBO_JOB_INBOX JI 		LEFT JOIN dbo_JOBPOSTINGS JP ON JI.JP_ID = JP.JP_ID 		LEFT JOIN bdjCorporate..JobLastViewedDate JV ON JV.JP_ID = JP.JP_ID  		LEFT JOIN DBO_BNG_JOBPOSTINGS JB ON JP.JP_ID = JB.JP_ID 	WHERE JI.P_ID = 6056723   ORDER BY  JI.P_DATE DESC OFFSET 0 ROWS FETCH NEXT 200 ROWS ONLY )SELECT DISTINCT T.JP_ID 	, CASE WHEN S.InterviewType < 2 THEN 1 ELSE 0 END AS [General Interview], S.ScheduleDate--, R.ReasonId, R.ReplyText  	, CASE WHEN S.InterviewType = 2 THEN 1 ELSE 0 END AS [Live Interview] , CASE WHEN S.InterviewType = 4 THEN 1 ELSE 0 END AS [Online Test]      , ROW_NUMBER()OVER(PARTITION BY T.JP_ID ORDER BY (CASE WHEN S.InterviewType < 2 THEN 1 ELSE 0 END) DESC , S.ScheduleDate DESC) As SL 	FROM Application_CTE I 		INNER JOIN rp.TestSteps T ON I.JP_ID = T.JP_ID 		INNER JOIN rp.Schedule S ON T.stId = S.stId 		LEFT JOIN rp.ApplicantProcess A ON S.schId = A.SchId AND  I.ApplyID = A.ApplyId AND A.Notify=1 	WHERE I.P_ID = 6056723 AND S.ScheduleDate > GETDATE()