--SELECT JP_ID, P_ID, ApplyID FROM bdjCorporate..DBO_JOB_INBOX WHERE JP_ID = 1236811

;WIth mainCTEE as(select DISTINCT o.P_ID,u.accFirstName+' '+u.accLastName as name ,O.TransDate as [Purchase Date],o.SysID,o.ServiceID from OnlinePaymentInfoJS oinner join UserAccounts u on o.p_id=u.accID where o.TransDate>='11/29/2023 20:00:00' and o.ServiceID in (87,88,89) AND O.TransStatus = 'S'--ORDER BY O.P_ID),END_CTE AS(SELECT DISTINCT M.P_ID, DATEADD(MONTH, cpkDuration, cpkStartDate) AS [Package End Date], C.cpkId,M.ServiceID FROM mainCTEE MINNER JOIN mnt.CandidatePackages C ON M.P_ID = C.P_Id AND M.SysID = C.cpkId--order by  M.P_ID),Final_CTE1 AS(SELECT DISTINCT M.P_ID, M.[Purchase Date], E.[Package End Date],LAG(E.[Package End Date]) OVER (PARTITION BY M.P_ID ORDER BY M.[Purchase Date]) D_Date,m.name,M.ServiceID FROM mainCTEE MINNER JOIN END_CTE E ON M.SysID = E.cpkId--where M.P_ID = 1045025--ORDER BY M.P_ID),Final_CTE as(select f.P_ID,f.[Purchase Date], f.[Package End Date],f.D_Date,f.name,f.ServiceID ,ROW_NUMBER() OVER (PARTITION BY f.P_ID ORDER BY f.[Purchase Date]) RNfrom Final_CTE1 f --5926720--where f.P_ID = 1045025--order by f.P_ID), f as(SELECT f.P_ID--,f.NAME,f.[Purchase Date] , CASE WHEN f.[Purchase Date] < f.D_Date  THEN 'YES' ELSE 'NO' END AS Upgrade, CASE WHEN f.[Purchase Date] > D_Date THEN 'YES' ELSE 'NO' END AS Repurchase--, CASE WHEN f.RN = 1 THEN 'YES' ELSE 'NO' END AS NEW, 'S' [Payment Status],f.ServiceID FROM Final_CTE f)select count(distinct P_ID) AS Jannatul_Count from f where Repurchase='Yes' and P_ID in(	5744922,	3995883,	3920537,	4637880,	3667138,	4862611,	4890061,	4898708,	4937399,	30854,	46663,	144452,	144452,	165895,	169397,	179595,	227479,	257639,	259399,	277517,	281546,	291524,	294898,	300139,	307044,	321187,	324028,	331370,	338876,	345771,	358971,	379866,	384596,	387611,	391533,	405283,	415865,	416318,	420946,	426560,	428188,	461339,	493372,	501821,	511533,	515170,	526902,	533659,	547265,	553993,	578474,	587541,	597100,	613926,	614382,	635490,	636437,	639002,	640330,	644440,	647854,	663300,	664454,	680237,	683905,	710723,	718073,	722900,	741012,	755534,	759918,	766144,	773206,	788057,	808501,	815298,	858516,	858950,	859463,	864961,	906441,	907392,	913422,	915136,	918093,	923734,	925731,	930341,	934658,	980623,	1000778,	1041543,	1043865,	1051469,	1052918,	1089857,	1097961,	1099861,	1104382,	1128085,	1133071,	1161075,	1163097,	1165048,	1165393,	1170436,	1193307,	1198291,	1201050,	1210052,	1219661,	1223145,	1224168,	1243424,	1247253,	1250493,	1250678,	1268477,	1268602,	1268921,	1269349,	1274798,	1286785,	1304598,	1306929,	1320554,	1324036,	1328598,	1335798,	1339294,	1343939,	1344795,	1356322,	1358580,	1365590,	1373686,	1389888,	1401328,	1437499,	1444990,	1449247,	1457163,	1469859,	1472825,	1472965,	1484183,	1486856,	1487846,	1494184,	1495949,	1509418,	1511838,	1522874,	1528909,	1530150,	1532739,	1533840,	1538324,	1544462,	1558096,	1561094,	1569185,	1574865,	1584057,	1586313,	1617714,	1617870,	1633038,	1654640,	1674609,	1676676,	1702216,	1705658,	1705944,	1709038,	1711029,	1719861,	1720440,	1721408,	1724843,	1725046,	1727279,	1734494,	1737043,	1749429,	1786533,	1818424,	1824481,	1832423,	1832738,	1833298,	1847512,	1874183,	1883711,	1922802,	1928511,	1948502,	2010195,	2024396,	2030610,	2031056,	2044431,	2055625,	2059700,	2062961,	2112328,	2116089,	2116714,	2118871,	2126373,	2142852,	2192565,	2196780,	2201166,	2217142,	2221654,	2244032,	2278767,	2306686,	2425702,	2442446,	2448906,	2454026,	2459807,	2460040,	2463334,	2495236,	2498895,	2504552,	2517946,	2520256,	2521981,	2522127,	2538022,	2539587,	2539700,	2585261,	2588581,	2607429,	2624225,	2660438,	2688652,	2693240,	2703924,	2706297,	2716759,	2718654,	2720319,	2730805,	2759007,	2761452,	2817538,	2820228,	2821454,	2843300,	2855052,	2857780,	2899377,	2904437,	2905675,	2913035,	2915547,	2924244,	2929325,	2933359,	2947893,	2948716,	2953193,	2977320,	2982838,	2983667,	3001107,	3028453,	3032083,	3037234,	3046805,	3063600,	3068317,	3092258,	3118099,	3121248,	3136796,	3137989,	3142675,	3156238,	3164643,	3167133,	3171223,	3186022,	3189238,	3196458,	3215959,	3234684,	3252159,	3253861,	3280742,	3285686,	3299541,	3332507,	3377919,	3379363,	3383075,	3388142,	3390182,	3393118,	3395167,	3401622,	3412737,	3413298,	3417436,	3423199,	3426252,	3431031,	3434709,	3443152,	3446594,	3459842,	3462692,	3467747,	3469678,	3471784,	3473282,	3477629,	3481230,	3483380,	3484163,	3487991,	3495715,	3505667,	3509402,	3511640,	3515548,	3519915,	3558205,	3561753,	3568115,	3568729,	3573668,	3574929,	3598480,	3624092,	3630936,	3666744,	3682469,	3696244,	3709638,	3715329,	3747448,	3775125,	3775735,	3777524,	3817263,	3825673,	3826036,	3834231,	3840194,	3863152,	3869646,	3898391,	3917211,	4507135,	4519607,	4523135,	4535221,	4549719,	4557848,	4567456,	4598260,	4616347,	4627716,	4636904,	4638457,	4638512,	4639850,	4642618,	4643738,	4649061,	4654071,	4663887,	4664421,	4664784,	4671515,	4678083,	4679176,	4680668,	4686988,	4690211,	4694486,	4695765,	4696434,	4697062,	4700407,	4704112,	4715338,	4716511,	4717345,	4718446,	4721173,	4721661,	4723981,	4732534,	4740793,	4744717,	4750432,	4752445,	4752887,	4755896,	4757099,	4757550,	4767770,	4769846,	4772992,	4777683,	4778747,	4790590,	4790948,	4792473,	4793998,	4794987,	4795964,	4796860,	4801016,	4807887,	4808234,	4808702,	4811385,	4811975,	4811976,	4812336,	4813124,	4813529,	4814287,	4814769,	4817355,	4818322,	4820125,	4823276,	4825839,	4826015,	4831928,	4837297,	4839094,	4840669,	4842845,	4846834,	4854170,	4858810,	4863634,	4864766,	4864780,	4866007,	4866883,	4874884,	4874978,	4875331,	4877938,	4878546,	4880352,	4880546,	4883338,	4883606,	4883685,	4888353,	4893498,	4893937,	4898356,	4905605,	4909676,	4910886,	4911240,	4914219,	4914653,	4914783,	4915552,	4919741,	4926621,	4928927,	4941680,	4943456,	4943666,	4943832,	4944506,	4945983,	4949202,	4954298,	4959910,	4964222,	4967111,	4969170,	4972203,	4977744,	4979584,	4993248,	4998512,	5002237,	5003614,	5010205,	5019356,	5034919,	5043271,	5046511,	5051046,	5051879,	5057128,	5057964,	5087353,	5091536,	5093406,	5094144,	5097612,	5101633,	5102784,	5116644,	5117420,	5125261,	5131843,	5134586,	5135938,	5137535,	5140760,	5141563,	5144299,	5153699,	5165752,	5167134,	5171416,	5175360,	5176399,	5177615,	5187267,	5192282,	5193808,	5197204,	5202135,	5208957,	5229819,	5242628,	5246642,	5253329,	5257580,	5258641,	5260175,	5260582,	5265422,	5267844,	5268488,	5269447,	5292704,	5292739,	5295475,	5308275,	5312959,	5319634,	5328044,	5328890,	5336914,	5344497,	5348374,	5360863,	5360968,	5361243,	5361512,	5361752,	5362738,	5371745,	5372694,	5375031,	5378768,	5388941,	5388997,	5389157,	5398529,	5398790,	5408076,	5717576,	5726056,	5728243,	5731920,	5732352,	5741016,	6413715,	6416414,	6416625,	6418813,	6425082,	6426530,	6437895,	6438961,	6440409,	6450940,	6455311,	6456675,	6456893,	6458288,	6458320,	6459772,	6463921,	6467018,	6475127,	6479698,	6481907,	6487356,	6489206,	6492519,	6493397,	6494091,	6497933,	6503070,	6508151,	6508645,	6510295,	6514429,	6515448,	6515575,	6521874,	6525816,	6527993,	6532338,	6532433,	6532907,	6534188,	6537905,	6539853,	6546643,	6556373,	6562068,	6567496,	6571532,	6579195,	6585588,	6592050,	6600589,	6610820,	6611461,	6612014,	6614791,	6617879,	6627020,	6628754,	6628858,	6631065,	6634403,	6646292,	6648484,	6653414,	6660826,	6663066,	6669997,	6678617,	6681971,	6683157,	6695659,	6700549,	6701442,	6705000,	6708638,	6716717,	6718509,	6721925,	6722802,	6727103,	6728485,	6729509,	6730972,	6731271,	6731871,	6733094,	6733780,	6733893,	6736249,	6744571,	6747824,	6749266,	6751745,	6752352,	6753794,	6753892,	6756741,	6759738,	6762129,	6765946,	6769293,	6778049,	6779476,	6780062,	6782264,	6796482,	6801474,	6804752,	6806200,	6807519,	6813207,	6815387,	6816818,	6819785,	6820380,	6821774,	6823038,	6824184,	6826254,	6830415,	6831268,	6832431,	6837155,	6837167,	6838859,	6839603,	6839961,	6846972,	6846972,	6851480,	6851480,	6853743,	6856930,	6857170,	6857626,	6857723,	6858131,	6859594,	6864345,	6864622,	6864886,	6865684,	6867099,	6869695,	6873581,	6877784,	6880893,	6886318,	6894152,	6894316,	6895298,	6895812,	6896460,	6900223,	6901907,	6904492,	6905290,	6905654,	6906029,	6906230,	6907629,	6907801,	6907897,	6911303,	6911479,	6912272,	6912783,	3330212,	3332218,	3333667,	3334621,	3335678,	3337716,	3345345,	3351483,	3353800,	3357516,	3374976,	3388041,	3395167,	3397745,	3399926,	3412308,	3426252,	3435541,	3437609,	3438145,	3442651,	3446554,	3450046,	3452398,	3463672,	3471784,	3474918,	3478507,	3486066,	3487691,	3490143,	3495690,	3504355,	3517115,	3519064,	3521323,	3521494,	3521930,	3531692,	4487852,	4494288,	4488868,	4515690,	4517866,	4519607,	4522811,	4527103,	4530823,	4531134,	4535803,	4542199,	4546807,	4560470,	4561326,	4592351,	4601275,	4607873,	4617014,	4619190,	4620566,	4624024,	4624024,	4627716,	4637013,	4637187,	3921370,	3946553,	3963903,	3966141,	3977810,	3980633,	3990685,	4001034,	4001844,	4008770,	4009743,	4038921,	4090073,	4090956,	4091496,	4095079,	4138125,	4214958,	4227981,	4248857,	4252956,	4253772,	4254739,	4275828,	4277117,	4316290,	4336602,	4346797,	4371504,	4387460,	4389831,	4397948,	4411563,	4413733,	4419758,	4461788,	4473749,	4554354,	4554989,	4558639,	4561655,	4575124,	4586865)--372