-- Company which Rejects Applicants WITH jobCTE AS (	SELECT DISTINCT j.CP_ID, j.JP_ID, 	CASE WHEN j.JobLang = 2 THEN bj.TITLE ELSE j.JobTitle END AS [Job Title],	COUNT(DISTINCT ji.ApplyID) AS [Total Applicants],	ROW_NUMBER() OVER(PARTITION BY j.CP_ID ORDER BY j.CP_ID DESC) AS r	FROM bdjCorporate..DBO_JOB_INBOX AS ji --ON ji.ApplyId = a.ApplyId	INNER JOIN bdjCorporate..DBO_JOBPOSTINGS AS j ON j.JP_ID = ji.JP_ID 	LEFT JOIN bdjCorporate..DBO_BNG_JOBPOSTINGS AS bj ON bj.JP_ID = j.JP_ID	WHERE j.PublishDate >= '05/01/2023 00:00:00' 	AND ji.Rejected = 1	GROUP BY j.CP_ID, j.JP_ID, j.[JobTitle], j.JobLang, bj.TITLE	--Order by COUNT(APPLYID) DESC)SELECT * FROM jobCTE WHERE r = 1, subCTE AS (	SELECT j.CP_ID, SUM(j.[Total Applicants]) AS TotalApplicants FROM jobCTE AS j	GROUP BY j.CP_ID)SELECT j.CP_ID, j.JP_ID, j.[Job Title], s.TotalApplicants FROM jobCTE jINNER JOIN subCTE AS s ON s.CP_ID = j.CP_IDORDER BY s.TotalApplicants DESC-- Cross checkSELECT COUNT(DISTINCT ji.ApplyId) FROM bdjCorporate..DBO_JOBPOSTINGS AS jINNER JOIN bdjCorporate..DBO_JOB_INBOX AS ji ON j.JP_ID = ji.JP_IDWHERE ji.Rejected = 1 AND j.CP_ID = 24330 --19829 --28640-- Company who have high ammounts of Candidates at last stage Screening process WITH lastCTE AS (	SELECT DISTINCT JP_ID, 	last_step = ROW_NUMBER() OVER(PARTITION BY JP_ID ORDER BY TestLevel DESC),	TestLevel	FROM bdjCorporate.rp.testSteps WHERE TestLevel > 1 --WHERE JP_ID = 1215553), jobCTE AS (	SELECT DISTINCT l.JP_ID, jp.CP_ID,	CASE WHEN jp.JobLang = 2 THEN bj.TITLE ELSE jp.JobTitle END AS [Job Title], l.TestLevel,	COUNT(DISTINCT a.ApplyId) AS [Total Candidates],	ROW_NUMBER() OVER(PARTITION BY jp.CP_ID ORDER BY jp.CP_ID DESC) AS r	FROM lastCTE AS l	INNER JOIN bdjCorporate..DBO_JOB_INBOX AS ji ON ji.JP_ID = l.JP_ID	INNER JOIN bdjCorporate..DBO_JOBPOSTINGS AS jp ON jp.JP_ID = ji.JP_ID	LEFT JOIN bdjCorporate..DBO_BNG_JOBPOSTINGS AS bj ON bj.JP_ID = jp.JP_ID	INNER JOIN bdjCorporate.rp.ApplicantProcess AS a ON a.ApplyId = ji.ApplyId AND l.TestLevel = a.LevelStatus	WHERE jp.PublishDate >= '05/01/2023 00:00:00'	AND last_step = 1	GROUP BY jp.CP_ID, l.JP_ID, jp.[JobTitle], jp.JobLang, bj.TITLE, l.TestLevel	--ORDER BY COUNT(DISTINCT a.ApplyId) DESC)SELECT * FROM jobCTE WHERE r = 1 ORDER BY [Total Candidates] DESC, subCTE AS (	SELECT DISTINCT j.CP_ID, SUM(j.[Total Candidates]) AS Candidates	FROM jobCTE AS j	GROUP BY j.CP_ID	--GROUP BY jp.CP_ID	--ORDER BY SUM(j.[Total Candidates]) DESC)SELECT j.CP_ID, j.JP_ID, j.[Job Title], s.Candidates FROM jobCTE AS jINNER JOIN subCTE AS s ON j.CP_ID = s.CP_IDORDER BY s.candidates DESC-- Cross CheckSELECT * FROM bdjCorporate.rp.TestSteps WHERE JP_ID = 1202733SELECT * FROM bdjCorporate..DBO_JOB_INBOX AS jINNER JOIN bdjCorporate.rp.ApplicantProcess AS r ON r.ApplyId = j.ApplyIDWHERE j.JP_ID = 1153607 AND r.LevelStatus = 2-- Company by highest order of Shortlisted SELECT j.CP_ID, j.JP_ID, CASE WHEN j.JobLang = 2 THEN bj.TITLE ELSE j.JobTitle END AS [Job Title],COUNT(DISTINCT a.ApplyId) AS [Total Shortlisted] FROM bdjCorporate..DBO_JOBPOSTINGS AS jLEFT JOIN bdjCorporate..DBO_BNG_JOBPOSTINGS AS bj ON bj.JP_ID = j.JP_IDINNER JOIN bdjCorporate..DBO_JOB_INBOX AS ji ON ji.JP_ID = j.JP_IDINNER JOIN bdjCorporate.rp.ApplicantProcess AS a ON a.ApplyId = ji.ApplyIDWHERE j.PublishDate > '05/01/2023 00:00:00'GROUP BY j.CP_ID, j.JP_ID, j.JobLang, j.JobTitle, bj.TITLEORDER BY COUNT(DISTINCT a.ApplyId) DESC-- Cross CheckSELECT TOP 5 * FROM bdjCorporate.rp.ApplicantProcess