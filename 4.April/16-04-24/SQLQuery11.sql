WITH jobCTE AS (	SELECT JP_ID, P_ID, ApplyID FROM bdjCorporate..DBO_JOB_INBOX WHERE JP_ID = 1236811 and ApplyID>=304193516 --1236811 --1236826 --1236832  --1236811), infoCTE AS (	SELECT DISTINCT p.ID AS P_ID, p.NAME AS [Name], CONVERT(DATE, p.BIRTH, 101) AS [Date of Birth], 	DATEDIFF(year, p.[BIRTH], jp.deadline) AS [Age as of Deadline], u.accPhone AS [Mobile No.], u.accEmail AS Email, NID,	--PRESENT_ADD AS [Contact Address], --PERMANENT_ADD AS [Permanent Address],	--PRESENT_ADD AS [Present Location], PERMANENT_ADD AS [Permanent Location],	DATEDIFF(YEAR, 0, DATEADD(MONTH, s.TExp, 0)) AS [Total Experience]	FROM jobCTE AS j	INNER JOIN bdjResumes..PERSONAL AS p ON j.P_ID = p.ID	INNER JOIN bdjResumes..UserAccounts AS u ON j.P_ID = u.accID	LEFT JOIN bdjResumes..UserSummary AS s ON j.P_ID = s.P_ID	INNER JOIN bdjCorporate..DBO_JOBPOSTINGS AS jp ON j.JP_ID = jp.JP_ID	WHERE p.ID>=10173 --and 	304193516), addressCTE AS ( 	SELECT J.P_ID, U1.Location AS PresentAddress, U2.Location AS PermanentAddress, U1.DistrictID AS D1, U2.DistrictID AS D2, U1.ThanaID	FROM jobCTE AS J 	LEFT JOIN bdjResumes..UserAddress U1 ON J.P_ID = U1.P_ID AND U1.AddressType IN (1,3)	LEFT JOIN bdjResumes..UserAddress U2 ON J.P_ID = U2.P_ID AND U2.AddressType IN (2,3) 	where J.P_ID>=10173), locationCTE AS (	SELECT A.P_ID	, REPLACE(REPLACE(' ' + ISNULL(A.PresentAddress, ' '), CHAR(10), ' '), CHAR(13), ' ') as PresentAddress --A.PresentAddress	, REPLACE(REPLACE(' ' + ISNULL(A.PermanentAddress, ' '), CHAR(10), ' '), CHAR(13), ' ') as PermanentAddress--A.PermanentAddress 	, L.L_Name AS PresentDistrict, L1.L_Name AS PermanentDistrict --, L2.L_Name AS Thana	, ROW_NUMBER() OVER(PARTITION BY A.P_ID ORDER BY A.PresentAddress, A.PermanentAddress DESC) AS [Row_Number]	FROM addressCTE AS A	LEFT JOIN bdjResumes..LOCATIONS L ON A.D1 = L.L_ID 	LEFT JOIN bdjResumes..LOCATIONS L1 ON A.D2 = L1.L_ID 	LEFT JOIN bdjResumes..LOCATIONS L2 ON A.ThanaID = L2.L_ID 		where A.P_ID>=10173), locationCTE1 AS (	SELECT DISTINCT P_ID, 		   PresentAddress AS [Contact Address], 		   PermanentAddress AS [Permanent Address], 		   PresentDistrict AS [Present Location], 		   PermanentDistrict AS [Permanent Location], 		   PermanentDistrict AS [Home District]		   , ROW_NUMBER() OVER(PARTITION BY P_ID ORDER BY PresentAddress, PermanentAddress DESC) AS [Row_Number]	FROM locationCTE AS l	WHERE l.Row_Number = 1 and 	P_ID>=10173), eduCTE1 AS (	SELECT DISTINCT j.P_ID, e.Education AS [Exam Name: SSC/Equivalent], e.PASSING_YEAR AS [SSC/Passing Year], b.BoardName AS [SSC/Equivalent Board]	, e.PERCENT_MARK AS [SSC/Equivalent Result]	, e.INSTITUTE AS [SSC/Equivalent Instituion]	, e.SUBJECT AS [SSC/ Equivalent Group]	, ROW_NUMBER() OVER(PARTITION BY j.P_ID ORDER BY e.Passing_Year DESC) AS r	FROM jobCTE AS j	LEFT JOIN bdjResumes..EDU AS e ON j.P_ID = e.P_ID	LEFT JOIN bdjResumes..[EDU_Boards] AS b ON e.BoardID = b.BoardID	WHERE Edulevel = 1 and 	j.P_ID>=10173), eduCTE1_f AS (SELECT * FROM eduCTE1 WHERE r = 1), eduCTE2 AS (	SELECT DISTINCT j.P_ID, e.Education AS [Exam Name: HSC/Equivalent], e.PASSING_YEAR AS [HSC/Passing Year], b.BoardName AS [HSC/Equivalent Board]	, e.PERCENT_MARK AS [HSC/Equivalent Result]	, e.INSTITUTE AS [HSC/Equivalent Instituion]	, e.SUBJECT AS [HSC/ Equivalent Group]	, ROW_NUMBER() OVER(PARTITION BY j.P_ID ORDER BY e.Passing_Year DESC) AS r	FROM jobCTE AS j	LEFT JOIN bdjResumes..EDU AS e ON j.P_ID = e.P_ID	LEFT JOIN bdjResumes..[EDU_Boards] AS b ON e.BoardID = b.BoardID	WHERE Edulevel = 2 and 	j.P_ID>=10173),eduCTE2_f AS (SELECT * FROM eduCTE2 WHERE r = 1), eduCTE3 AS (	SELECT DISTINCT j.P_ID, e.Education AS [Exam Name: Graduation/Equivalent], e.PASSING_YEAR AS [Graduation/Passing Year]	, e.PERCENT_MARK AS [Graduation/Equivalent Result]	, e.INSTITUTE AS [Graduation University Name]	, e.INSTITUTE AS [Graduation Instituion/Faculty Name]	, e.SUBJECT AS [Graduation on Major1]	, e.SUBJECT AS [Graduation on Major2]	, ROW_NUMBER() OVER(PARTITION BY j.P_ID ORDER BY e.Passing_Year DESC) AS r	FROM jobCTE AS j												-- 66082 double entity	LEFT JOIN bdjResumes..EDU AS e ON j.P_ID = e.P_ID	LEFT JOIN bdjResumes..[EDU_Boards] AS b ON e.BoardID = b.BoardID	WHERE Edulevel = 4 and 	j.P_ID>=10173),eduCTE3_f AS (SELECT * FROM eduCTE3 WHERE r = 1), eduCTE4 AS (	SELECT DISTINCT j.P_ID, e.Education AS [Exam Name: Post-Graduation/Equivalent], e.PASSING_YEAR AS [Post-Graduation/Passing Year]	, e.PERCENT_MARK AS [Post-Graduation/Equivalent Result]	, e.INSTITUTE AS [Post-Graduation University Name]	, e.INSTITUTE AS [Post-Graduation Instituion/Faculty Name]	, e.SUBJECT AS [Post-Graduation on Major1]	, e.SUBJECT AS [Post-Graduation on Major2]	, ROW_NUMBER() OVER(PARTITION BY j.P_ID ORDER BY e.Passing_Year DESC) AS r	FROM jobCTE AS j												-- 66082 double entity	LEFT JOIN bdjResumes..EDU AS e ON j.P_ID = e.P_ID	LEFT JOIN bdjResumes..[EDU_Boards] AS b ON e.BoardID = b.BoardID	WHERE Edulevel = 5 and 	j.P_ID>=10173),eduCTE4_f AS (SELECT * FROM eduCTE4 WHERE r = 1),expCTE AS (SELECT     p_id,      MAX(CASE WHEN rn = 1 and ETO is null THEN Efrom else null END) AS currentExp_sdate,	MAX(CASE WHEN rn = 1  and ETO is null THEN company else null END) AS orgname,	MAX(CASE WHEN rn = 1 and ETO is null THEN eposition else null END) AS designation,		MAX(CASE WHEN rn = 1 and ETO is not null THEN Efrom END) AS Experience1_sdate,	MAX(CASE WHEN rn = 1 and ETO is not null THEN ETO END) AS Experience1_edate,	MAX(CASE WHEN rn = 1  and ETO is not null THEN company END ) AS orgname1,	MAX(CASE WHEN rn = 1 and ETO is not null THEN eposition  END) AS designation1,    MAX(CASE WHEN rn = 2 THEN Efrom END) AS Experience2_sdate,	MAX(CASE WHEN rn = 2 THEN Eto END) AS Experience2_edate,	MAX(CASE WHEN rn = 2 THEN company END) AS orgname2,	MAX(CASE WHEN rn = 2 THEN eposition END) AS designation2,    MAX(CASE WHEN rn = 3 THEN Efrom END) AS Experience3_sdate,	MAX(CASE WHEN rn = 3 THEN Eto END) AS Experience3_edate,	MAX(CASE WHEN rn = 3 THEN company END) AS orgname3,	MAX(CASE WHEN rn = 3 THEN eposition END) AS designation3,    MAX(CASE WHEN rn = 4 THEN Efrom END) AS Experience4_sdate,	MAX(CASE WHEN rn = 4 THEN Eto END) AS Experience4_edate,	MAX(CASE WHEN rn = 4 THEN company END) AS orgname4,	MAX(CASE WHEN rn = 4 THEN eposition END) AS designation4,	MAX(CASE WHEN rn = 5 THEN Efrom END) AS Experience5_sdate,	MAX(CASE WHEN rn = 5 THEN Eto END) AS Experience5_edate,	MAX(CASE WHEN rn = 5 THEN company END) AS orgname5,	MAX(CASE WHEN rn = 5 THEN eposition END) AS designation5FROM (    SELECT         e.p_id,		e.company,		e.eposition,        e.Efrom,		e.eto,        ROW_NUMBER() OVER (PARTITION BY e.p_id ORDER BY e.Efrom DESC) AS rn    FROM bdjResumes..exp e	inner join jobCTE j on e.P_ID = j.P_ID	where  	e.P_ID>=10173) AS subqueryGROUP BY  p_id)SELECT j.ApplyID AS [Job Ref ID]--, j.P_ID	, i.[Name], i.[Date of Birth], i.[Age as of Deadline], i.[Mobile No.], i.Email, i.NID AS [NID Number] --, i.[Contact Address], i.[Permanent Address], i.[Present Location], i.[Permanent Location], i.[Home District]	, l.[Contact Address], l.[Permanent Address], l.[Present Location], l.[Permanent Location], l.[Home District]	, e1.[Exam Name: SSC/Equivalent], e1.[SSC/Passing Year], e1.[SSC/Equivalent Board], e1.[SSC/Equivalent Result], e1.[SSC/Equivalent Instituion], e1.[SSC/ Equivalent Group]	, e2.[Exam Name: HSC/Equivalent], e2.[HSC/Passing Year], e2.[HSC/Equivalent Board], e2.[HSC/Equivalent Result], e2.[HSC/Equivalent Instituion], e2.[HSC/ Equivalent Group]	, e3.[Exam Name: Graduation/Equivalent], e3.[Graduation/Passing Year], e3.[Graduation University Name], e3.[Graduation Instituion/Faculty Name], e3.[Graduation/Equivalent Result], e3.[Graduation on Major1], e3.[Graduation on Major2]	, e4.[Exam Name: Post-Graduation/Equivalent], e4.[Post-Graduation/Passing Year],  e4.[Post-Graduation University Name], e4.[Post-Graduation Instituion/Faculty Name], e4.[Post-Graduation/Equivalent Result], e4.[Post-Graduation/Equivalent Result], e4.[Post-Graduation on Major1], e4.[Post-Graduation on Major2]	, ex.orgname AS [Currently Employed Company Name], ex.designation AS [Current Designation], ex.currentExp_sdate AS [Starting Date in Current Organization]  	--,ex.Experience1_edate	, ex.orgname1,ex.designation1, ex.Experience1_sdate, ex.Experience1_edate	, ex.orgname2 AS [Previous organization 1], ex.designation2 AS [Previous Designation 1], ex.Experience2_sdate AS [Start Date in Previous Organization 1], ex.Experience2_edate AS [End Date in Previous Organization 1]	, ex.orgname3 AS [Previous organization 2], ex.designation3 AS [Previous Designation 2], ex.Experience3_sdate AS [Start Date in Previous Organization 2], ex.Experience3_edate AS [End Date in Previous Organization 2]	, ex.orgname4 AS [Previous organization 3], ex.designation4 AS [Previous Designation 3], ex.Experience4_sdate AS [Start Date in Previous Organization 3], ex.Experience4_edate AS [End Date in Previous Organization 3]	, ex.orgname5 AS [Previous organization 4], ex.designation5 AS [Previous Designation 4], ex.Experience5_sdate AS [Start Date in Previous Organization 4], ex.Experience5_edate AS [End Date in Previous Organization 4]	, i.[Total Experience]FROM jobCTE AS j	LEFT JOIN infoCTE AS i ON j.P_ID = i.P_ID	LEFT JOIN locationCTE1 AS l ON j.P_ID = l.P_ID	LEFT JOIN eduCTE1_f AS e1 ON j.P_ID = e1.P_ID	LEFT JOIN eduCTE2_f AS e2 ON j.P_ID = e2.P_ID	LEFT JOIN eduCTE3_f AS e3 ON j.P_ID = e3.P_ID	LEFT JOIN eduCTE4_f AS e4 ON j.P_ID = e4.P_ID	LEFT JOIN expCTE AS ex ON j.P_ID = ex.P_ID	where ex.currentExp_sdate is null and  ApplyID>=304193516	--order by  j.ApplyID	--where ex.currentExp_sdate is not null--WHERE i.[Name] LIKE '%Halim%'--WHERE e1.r1 = 1 AND e2.r2 = 1 AND e3.r3 = 1 AND e4.r4 = 1 AND l.Row_Number = 1