WITH jobCTE AS (	SELECT J.JP_ID, j.PublishDate AS [Publish Date], COUNT(ji.Applyid) AS [Total Applied] ,	count(case when a.applyid is not null then 1 end) [Total Shortlisted]	FROM bdjCorporate..DBO_JOBPOSTINGS AS j	INNER JOIN  bdjCorporate..DBO_JOB_INBOX AS ji ON j.JP_ID = ji.JP_ID	LEFT JOIN bdjCorporate.rp.ApplicantProcess a on ji.ApplyID = a.ApplyId	WHERE CONVERT(DATE, j.PublishDate, 101) > '11/29/2023'	GROUP BY j.JP_ID,j.PublishDate),packageCTE AS (	SELECT DISTINCT o.P_ID,c.cpkStartDate AS [Start Date], DATEADD(MONTH, cpkDuration, cpkStartDate) AS EndDate 	FROM bdjResumes..OnlinePaymentInfoJS AS o	INNER JOIN bdjResumes.mnt.CandidatePackages AS c ON c.P_ID = o.P_ID AND o.SysID = c.cpkId	WHERE o.ServiceId IN (87, 88, 89) AND o.TransStatus = 'S'),finalpart as(SELECT  case when j.P_DATE >= p.[Start Date] AND j.P_DATE <= p.EndDate then J.ApplyID end as Applyid, j.P_DATE,j.JP_ID--,a.applyidFROM  packageCTE AS pINNER JOIN bdjCorporate..[DBO_JOB_INBOX] AS j ON p.P_ID = j.P_ID inner join jobCTE jo on j.JP_ID=Jo.JP_IDWhere j.p_date>='11/29/2023'),finalpartproshortlist as(SELECT p.JP_ID, count(a.applyid) as total_pro_shortlistFROM finalpart AS pINNER JOIN bdjCorporate.rp.ApplicantProcess a on p.ApplyID = a.ApplyIdWhere p.p_date>='11/29/2023' and p.Applyid is not nullgroup by p.JP_ID)select j.JP_ID,j.[Publish Date],j.[Total Applied],j.[Total Shortlisted], count(case when Applyid is not null then 1 end) [Total Pro Applied] ,f1.total_pro_shortlistfrom jobCTE jINNER JOIN finalpart f on j.JP_ID = f.JP_IDINNER JOIN finalpartproshortlist f1 on j.JP_ID = f1.JP_IDgroup by j.JP_ID,j.[Publish Date],j.[Total Applied],j.[Total Shortlisted],f1.total_pro_shortlistorder by j.JP_ID